<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
    <Rule language="beanshell" name="CMH-Infor-Full-Post-Iteration-Rule">
        <Description>This rule is used to update the timestamp of the application object</Description>
        <Source>
            <![CDATA[
            import org.apache.log4j.Logger;
            import sailpoint.object.Application;
            import sailpoint.object.Custom;
            import sailpoint.object.TaskResult;
            import sailpoint.object.TaskResult.CompletionStatus;
            import sailpoint.tools.Util;
            
		    Logger log = Logger.getLogger("cmh.authsource.rules");
		    log.debug("CMH-Infor-Full-Post-Iteration-Rule: Entering");
		    
            private boolean taskSucessStatus(String taskName) {
              log.debug("CMH-Infor-Full-Post-Iteration-Rule: Entering taskSucessStatus");
              boolean isSuccess = false;
              if(Util.isNotNullOrEmpty(taskName)) {
                  TaskResult result = context.getObjectByName(TaskResult.class,taskName);
                  if(null != result) {
                     CompletionStatus res = result.getCompletionStatus();
                     if(res != null) {
	                     String message = res.getMessageKey();
	                     if(Util.nullSafeCaseInsensitiveEq(message, "task_result_success")) {
	                        isSuccess = true;
	                     }
                     }
                  }
               }
               log.debug("CMH-Infor-Full-Post-Iteration-Rule: Exiting taskSucessStatus : isSuccess ?"+isSuccess);
               return isSuccess;
            }
            Custom custom = context.getObjectByName(Custom.class,"CMH-Infor-Full-Aggregation-Custom-Object");
            if(custom != null) {
               String taskName = (String) custom.get("taskName");
               boolean istaskSuccess = taskSucessStatus(taskName); 
               String timeStamp = null;
               if(istaskSuccess) {
                  timeStamp = (String) custom.get("lastRunTimeStamp");
               }else {
                  timeStamp = (String) custom.get("oldRunTimeStamp");
               }
               if(Util.isNotNullOrEmpty(timeStamp)) {
                  String appName = (String) custom.get("applicationName");
                  if(Util.isNotNullOrEmpty(appName)) {
                     Application app = context.getObjectByName(Application.class,appName);
					 if(app != null) {
					    String sqlQuery = (String) custom.get("sqlQueryIncremental");
					    if(Util.isNotNullOrEmpty(sqlQuery) && sqlQuery.contains("TIME_STAMP")){
						   sqlQuery = sqlQuery.replace("TIME_STAMP",timeStamp);						   
					    }
					    app.setAttribute("SQL",sqlQuery);
					    try {
					          context.saveObject(app);
							  context.commitTransaction();
							} catch (GeneralException e) {
								 log.error("ERROR : CMH-Infor-Full-Post-Iteration-Rule:"+e.getMessage());
						    };
					   }
                   }
               }
            }
            log.debug("CMH-Infor-Full-Post-Iteration-Rule: Exiting");
            ]]>
        </Source>
    </Rule>
</sailpoint>